name: Send Peppol UBL via Scrada

on:
  workflow_dispatch:
    inputs:
      file:
        description: 'Path to UBL file'
        required: true
      environment:
        description: 'apitest or prod'
        required: true
        default: 'apitest'
      externalRef:
        description: 'External reference (optional)'
        required: false
      buyerReference:
        description: 'cbc:BuyerReference (leave blank to use OrderId or auto)'
        required: false
      orderId:
        description: 'cac:OrderReference/cbc:ID (optional alternative)'
        required: false

jobs:
  send:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Compute UBL artifact paths
        id: ubl_paths
        shell: pwsh
        run: |
          $input = '${{ github.event.inputs.file }}'
          if (-not $input -or $input.Trim().Length -eq 0) { throw "Missing input path" }
          $patched = [System.IO.Path]::ChangeExtension($input, 'send.xml')
          "patched=$patched" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: Send UBL via Scrada
        shell: pwsh
        env:
          SCRADA_COMPANY_ID:         ${{ secrets.SCRADA_COMPANY_ID }}
          SCRADA_API_KEY:            ${{ secrets.SCRADA_API_KEY }}
          SCRADA_API_PASSWORD:       ${{ secrets.SCRADA_API_PASSWORD }}
          SCRADA_PEPPOL_SENDER_ID:   ${{ secrets.SCRADA_PEPPOL_SENDER_ID || format('{0}:{1}', vars.SCRADA_SUPPLIER_SCHEME, vars.SCRADA_SUPPLIER_ID) }}
          SCRADA_PEPPOL_RECEIVER_ID: ${{ secrets.SCRADA_PEPPOL_RECEIVER_ID || format('{0}:{1}', vars.SCRADA_TEST_RECEIVER_SCHEME, vars.SCRADA_TEST_RECEIVER_ID) }}
        run: >
          ./tools/scrada-peppol/Send-PeppolUbl.ps1
          -InputPath "${{ github.event.inputs.file }}"
          -OutputPath "${{ steps.ubl_paths.outputs.patched }}"
          -Environment "${{ github.event.inputs.environment }}"
          -BuyerReference "${{ github.event.inputs.buyerReference }}"
          -OrderId "${{ github.event.inputs.orderId }}"
          -ExternalReference "${{ github.event.inputs.externalRef }}"
      - name: Upload UBL artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scrada-ubl-${{ github.run_id }}
          if-no-files-found: warn
          path: |
            ${{ github.event.inputs.file }}
            ${{ steps.ubl_paths.outputs.patched }}
