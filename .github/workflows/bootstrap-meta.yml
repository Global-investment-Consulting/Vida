name: Bootstrap Repo Meta

on:
  workflow_dispatch:
    inputs:
      force:
        description: Run even if already bootstrapped
        type: boolean
        default: false
  push:
    branches:
      - main

jobs:
  bootstrap-meta:
    name: Seed repository metadata
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force == 'true' || hashFiles('.github/BOOTSTRAPPED') == '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Seed repository metadata
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const core = require('@actions/core');
            const { owner, repo } = context.repo;

            const labelDefinitions = [
              { name: 'feature', color: '0366d6', description: 'Feature work' },
              { name: 'adapter', color: '1f883d', description: 'Adapter implementations' },
              { name: 'validator', color: '8a2be2', description: 'Validator and schema updates' },
              { name: 'plugin', color: 'a371f7', description: 'Plugin development' },
              { name: 'infra', color: 'd73a4a', description: 'Infrastructure and tooling' }
            ];

            const milestoneTitles = [
              'M1 Monorepo & Validator',
              'M2 Peppol Live',
              'M3 Italy SDI (Mock)',
              'M4 France PDP (Mock)',
              'M5 PL/HU/ES (Mocked)',
              'M6 Routing/API/Plugins',
              'M7 Hardening & Docs'
            ];

            const issueTitle = 'Repo settings checklist';
            const issueBody = [
              '- [ ] Enable Auto-merge in repo settings',
              "- [ ] Protect 'main': require PR + checks (build-test, fixtures-matrix, e2e-smoke) and up-to-date branches"
            ].join('\n');

            async function seedLabels() {
              core.info('Seeding labels...');
              const existing = await github.paginate(github.rest.issues.listLabelsForRepo, { owner, repo });
              for (const label of labelDefinitions) {
                const current = existing.find((item) => item.name.toLowerCase() === label.name.toLowerCase());
                if (!current) {
                  core.info('Creating label ' + label.name);
                  await github.rest.issues.createLabel({ owner, repo, ...label });
                  continue;
                }
                const needsUpdate =
                  current.color.toLowerCase() !== label.color.toLowerCase() ||
                  (current.description ?? '') !== (label.description ?? '');
                if (needsUpdate) {
                  core.info('Updating label ' + label.name);
                  await github.rest.issues.updateLabel({
                    owner,
                    repo,
                    name: current.name,
                    new_name: label.name,
                    color: label.color,
                    description: label.description
                  });
                } else {
                  core.info('Label ' + label.name + ' is up to date');
                }
              }
            }

            async function seedMilestones() {
              core.info('Seeding milestones...');
              const existing = await github.paginate(github.rest.issues.listMilestones, {
                owner,
                repo,
                state: 'all'
              });
              for (const title of milestoneTitles) {
                const hit = existing.find((item) => item.title === title);
                if (!hit) {
                  core.info('Creating milestone ' + title);
                  await github.rest.issues.createMilestone({ owner, repo, title });
                } else {
                  core.info('Milestone ' + title + ' already exists (state: ' + hit.state + ')');
                }
              }
            }

            async function ensureChecklistIssue() {
              core.info('Ensuring Repo settings checklist issue exists...');
              const issues = await github.paginate(github.rest.issues.listForRepo, {
                owner,
                repo,
                state: 'all'
              });
              const existing = issues.find((issue) => !issue.pull_request && issue.title === issueTitle);
              if (existing) {
                core.info('Issue already exists (#' + existing.number + ')');
                return;
              }
              core.info('Creating checklist issue');
              await github.rest.issues.create({
                owner,
                repo,
                title: issueTitle,
                body: issueBody,
                labels: ['infra']
              });
            }

            async function writeSentinel() {
              core.info('Writing sentinel file .github/BOOTSTRAPPED');
              const path = '.github/BOOTSTRAPPED';
              let sha;
              try {
                const current = await github.rest.repos.getContent({ owner, repo, path });
                if (!Array.isArray(current.data) && current.data.type === 'file') {
                  sha = current.data.sha;
                }
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
              }
              const payload = Buffer.from('bootstrapped=' + new Date().toISOString() + '\n').toString('base64');
              await github.rest.repos.createOrUpdateFileContents({
                owner,
                repo,
                path,
                message: 'chore: mark metadata bootstrap complete',
                content: payload,
                sha,
                committer: {
                  name: 'github-actions[bot]',
                  email: '41898282+github-actions[bot]@users.noreply.github.com'
                },
                author: {
                  name: 'github-actions[bot]',
                  email: '41898282+github-actions[bot]@users.noreply.github.com'
                }
              });
            }

            await seedLabels();
            await seedMilestones();
            await ensureChecklistIssue();
            await writeSentinel();

            core.notice('Metadata bootstrap complete.');
