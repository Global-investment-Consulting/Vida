name: ci

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      # 1ï¸âƒ£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set up Node
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Start API in background and wait until /healthz returns OK (Linux)
      - name: Start API (bg) and wait [Linux]
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          echo "Starting API in background..."
          npm run start:ci > api_log.txt 2>&1 &
          echo $! > server.pid

          echo "Waiting for /healthz to return OK..."
          HEALTH_URL="http://127.0.0.1:3001/healthz" \
          WAIT_TIMEOUT_MS=150000 \
          npm run --silent wait:api

      # 5ï¸âƒ£ Start API in background and wait until /healthz returns OK (Windows)
      - name: Start API (bg) and wait [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Starting API in background..."
          $p = Start-Process node "server.js" `
               -RedirectStandardOutput api_log.txt `
               -RedirectStandardError  api_log.txt `
               -NoNewWindow -PassThru
          $p.Id | Out-File server.pid -Encoding ascii -NoNewline

          Write-Host "Waiting for /healthz to return OK..."
          $env:HEALTH_URL = "http://127.0.0.1:3001/healthz"
          $env:WAIT_TIMEOUT_MS = "150000"
          npm run --silent wait:api

      # 6ï¸âƒ£ Run smoke test (adjust or replace this with your actual test)
      - name: Run smoke test
        run: npm run ubl:smoke

      # 7ï¸âƒ£ Print logs if anything failed (Linux)
      - name: Print API log on failure [Linux]
        if: failure() && runner.os != 'Windows'
        shell: bash
        run: |
          echo "---- api_log.txt (first 200 lines) ----"
          sed -n '1,200p' api_log.txt || true

      # 8ï¸âƒ£ Print logs if anything failed (Windows)
      - name: Print API log on failure [Windows]
        if: failure() && runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path api_log.txt) {
            Write-Host "---- api_log.txt (first 200 lines) ----"
            Get-Content api_log.txt -TotalCount 200
          }

      # 9ï¸âƒ£ Always stop the background API (Linux)
      - name: Stop API [Linux]
        if: always() && runner.os != 'Windows'
        shell: bash
        run: |
          if [[ -f server.pid ]]; then
            kill $(cat server.pid) 2>/dev/null || true
          fi

      # ðŸ”Ÿ Always stop the background API (Windows)
      - name: Stop API [Windows]
        if: always() && runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path server.pid) {
            $pid = Get-Content server.pid
            Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
          }
