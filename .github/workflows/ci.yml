name: ci

on:
  push:
    branches: [ feat/a1-json-to-ubl ]
  pull_request:

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start API (bg) and wait (Ubuntu)
        env:
          LOG_PATH: ${{ runner.temp }}/api_ubuntu.log
          PID_PATH: ${{ runner.temp }}/server.pid
          HEALTH_URL: http://127.0.0.1:3001/healthz
          WAIT_TIMEOUT_MS: '30000'
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"   # ensure correct working dir
          nohup node server.js >"$LOG_PATH" 2>&1 & echo $! > "$PID_PATH"
          npm run wait:api

      - name: Smoke test (Ubuntu)
        run: |
          set -euo pipefail
          curl -fsS http://127.0.0.1:3001/healthz | grep -i "ready"

      - name: Print API logs on failure (Ubuntu)
        if: failure()
        env:
          LOG_PATH: ${{ runner.temp }}/api_ubuntu.log
        run: |
          echo "::group::api_ubuntu.log"
          [ -f "$LOG_PATH" ] && tail -n +1 "$LOG_PATH" || echo "no log file"
          echo "::endgroup::"

      - name: Stop API (Ubuntu)
        if: always()
        env:
          PID_PATH: ${{ runner.temp }}/server.pid
        run: |
          if [ -f "$PID_PATH" ]; then
            PID="$(cat "$PID_PATH" || true)"
            if [ -n "${PID:-}" ] && kill -0 "$PID" 2>/dev/null; then
              kill "$PID" || true
              sleep 2
              kill -9 "$PID" 2>/dev/null || true
            fi
          fi

  test-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start API (bg) and wait (Windows)
        env:
          LOG_PATH: ${{ runner.temp }}\api_windows.log
          PID_PATH: ${{ runner.temp }}\server.pid
          HEALTH_URL: http://127.0.0.1:3001/healthz
          WAIT_TIMEOUT_MS: '30000'
        run: |
          $ErrorActionPreference = 'Stop'
          $logMerged = $env:LOG_PATH
          $pidFile = $env:PID_PATH
          $logOut = "$env:RUNNER_TEMP\api_windows_out.log"
          $logErr = "$env:RUNNER_TEMP\api_windows_err.log"

          New-Item -ItemType Directory -Force -Path ([System.IO.Path]::GetDirectoryName($logMerged)) | Out-Null

          $proc = Start-Process -FilePath "node" `
                                -ArgumentList "server.js" `
                                -WorkingDirectory $PWD.Path `
                                -RedirectStandardOutput $logOut `
                                -RedirectStandardError  $logErr `
                                -PassThru -WindowStyle Hidden

          Set-Content -Path $pidFile -Value $proc.Id -Encoding ascii

          # merge logs so later steps can read one file
          Get-Content $logOut, $logErr | Set-Content $logMerged

          npm run wait:api

      - name: Smoke test (Windows)
        run: |
          (Invoke-WebRequest -Uri "http://127.0.0.1:3001/healthz" -UseBasicParsing).Content | Select-String -Pattern "ready" | Out-Null

      - name: Print API logs on failure (Windows)
        if: failure()
        env:
          LOG_PATH: ${{ runner.temp }}\api_windows.log
        run: |
          Write-Host "::group::api_windows.log"
          if (Test-Path $env:LOG_PATH) {
            Get-Content $env:LOG_PATH -Raw
          } else {
            Write-Host "no log file"
          }
          Write-Host "::endgroup::"

      - name: Stop API (Windows)
        if: always()
        env:
          PID_PATH: ${{ runner.temp }}\server.pid
        run: |
          $pidFile = $env:PID_PATH
          if (Test-Path $pidFile) {
            $pid = Get-Content $pidFile -ErrorAction SilentlyContinue
            if ($pid) {
              try {
                Stop-Process -Id ([int]$pid) -Force -ErrorAction SilentlyContinue
              } catch {}
            }
          }
