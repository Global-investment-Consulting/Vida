name: ci

on:
  push:
    branches: [ feat/a1-json-to-ubl ]
  pull_request:
    branches: [ feat/a1-json-to-ubl ]
  workflow_dispatch: {}

jobs:
  test-ubuntu:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start API (bg) and wait (Ubuntu)
        env:
          HEALTH_URL: http://127.0.0.1:3001/healthz
          WAIT_TIMEOUT_MS: 20000
        run: |
          set -e
          LOG="$RUNNER_TEMP/vida_api_ubuntu.log"
          PIDFILE="$RUNNER_TEMP/vida_api_ubuntu.pid"
          : > "$LOG"
          nohup node server.js >"$LOG" 2>&1 & echo $! > "$PIDFILE"
          node scripts/wait-for-api.mjs
          echo "API is up (Ubuntu)."

      - name: Smoke test (Ubuntu)
        run: |
          curl -fsS "http://127.0.0.1:3001/healthz" | grep -q "ready"

      - name: Print API logs on failure (Ubuntu)
        if: failure()
        run: |
          LOG="$RUNNER_TEMP/vida_api_ubuntu.log"
          test -f "$LOG" && tail -n 200 "$LOG" || echo "No ubuntu log found."

      - name: Stop API (Ubuntu)
        if: always()
        run: |
          PIDFILE="$RUNNER_TEMP/vida_api_ubuntu.pid"
          if [ -f "$PIDFILE" ]; then
            kill "$(cat "$PIDFILE")" 2>/dev/null || true
          fi

  test-windows:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start API (bg) and wait (Windows)
        shell: pwsh
        env:
          HEALTH_URL: http://127.0.0.1:3001/healthz
          WAIT_TIMEOUT_MS: 20000
        run: |
          $Log     = Join-Path $env:RUNNER_TEMP 'vida_api_windows.log'
          $PidFile = Join-Path $env:RUNNER_TEMP 'vida_api_windows.pid'

          # Ensure log file exists before any Get-Content or redirection
          New-Item -Path $Log -ItemType File -Force | Out-Null

          # Start node in background with the repository as working directory
          $proc = Start-Process -FilePath 'node' `
                                -ArgumentList 'server.js' `
                                -WorkingDirectory $env:GITHUB_WORKSPACE `
                                -WindowStyle Hidden `
                                -RedirectStandardOutput $Log `
                                -RedirectStandardError  $Log `
                                -PassThru

          $proc.Id | Set-Content -Path $PidFile

          # Wait until the API answers 200/OK on /healthz
          node scripts/wait-for-api.mjs

          Write-Host "API is up (Windows). PID=$($proc.Id)"

      - name: Smoke test (Windows)
        shell: pwsh
        run: |
          # Use curl.exe so we get the real curl, not Invoke-WebRequest alias
          $res = & curl.exe -fsS "http://127.0.0.1:3001/healthz"
          if ($LASTEXITCODE -ne 0 -or ($res | Select-String -SimpleMatch 'ready') -eq $null) {
            Write-Error "Smoke check failed."
          }

      - name: Print API logs on failure (Windows)
        if: failure()
        shell: pwsh
        run: |
          $Log = Join-Path $env:RUNNER_TEMP 'vida_api_windows.log'
          if (Test-Path $Log) { Get-Content -Path $Log -Tail 200 } else { Write-Host "No windows log found." }

      - name: Stop API (Windows)
        if: always()
        shell: pwsh
        run: |
          $PidFile = Join-Path $env:RUNNER_TEMP 'vida_api_windows.pid'
          if (Test-Path $PidFile) {
            $pid = Get-Content $PidFile | Select-Object -First 1
            if ($pid) { Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue }
          }
