name: Smoke Ops Dashboard
<<<<<<< HEAD

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Branch to test
        required: false
        type: string

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      REGION: ${{ vars.REGION != '' && vars.REGION || 'europe-west1' }}
      SERVICE: ${{ vars.SERVICE != '' && vars.SERVICE || 'vida-staging' }}
      OPS_DASHBOARD_ENABLED: ${{ vars.OPS_DASHBOARD_ENABLED || 'false' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID != '' && vars.GCP_PROJECT_ID || 'vida-staging-1760866919' }}

      - name: Resolve service URL
        id: url
        shell: bash
        run: |
          set -Eeuo pipefail
          URL=$(gcloud run services describe "${SERVICE}" --region="${REGION}" --format='value(status.url)')
          if [[ -z "${URL}" ]]; then
            echo "::error title=Resolve service URL failed::Cloud Run service ${SERVICE} missing URL"
            exit 1
          fi
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: GET /_health
        shell: bash
        run: |
          set -Eeuo pipefail
          curl -fsS "${{ steps.url.outputs.url }}/_health" | sed -n '1,40p'

      - name: GET /ops/submissions (tail)
        if: ${{ env.OPS_DASHBOARD_ENABLED == 'true' }}
        shell: bash
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_DASHBOARD_KEY }}
        run: |
          set -Eeuo pipefail
          curl -fsS -H "X-Admin-Key: ${ADMIN_KEY}" "${{ steps.url.outputs.url }}/ops/submissions?limit=1" | sed -n '1,80p'
=======
on:
  workflow_dispatch: {}
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Curl /ops/health
        env:
          ADMIN_DASHBOARD_KEY: ${{ secrets.ADMIN_DASHBOARD_KEY }}
          SERVICE_HOST: ${{ vars.SERVICE_HOST || '' }}
        run: |
          set -Eeuo pipefail
          if [[ -z "${SERVICE_HOST}" ]]; then
            echo "::error title=Missing SERVICE_HOST::Define repository variable SERVICE_HOST (e.g., https://vida-staging-xxxxxxxx.a.run.app)"; exit 1
          fi
          code=$(curl -sS -o /dev/null -w "%{http_code}" -H "X-Admin-Key: ${ADMIN_DASHBOARD_KEY}" "${SERVICE_HOST}/ops/health")
          echo "HEALTH_HTTP=${code}"
          test "${code}" = "200"
      - name: Curl /ops/submissions
        env:
          ADMIN_DASHBOARD_KEY: ${{ secrets.ADMIN_DASHBOARD_KEY }}
          SERVICE_HOST: ${{ vars.SERVICE_HOST || '' }}
        run: |
          set -Eeuo pipefail
          curl -sS -H "X-Admin-Key: ${ADMIN_DASHBOARD_KEY}" "${SERVICE_HOST}/ops/submissions?limit=5" | head -n 60
>>>>>>> 13eb356 (chore(ops): add ops dashboard smoke workflow)
