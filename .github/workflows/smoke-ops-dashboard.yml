name: Smoke Ops Dashboard

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Branch to test
        required: false
        type: string

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GCP_PROJECT_ID || vars.GCP_PROJECT_ID_STAGING || 'vida-staging-1760866919' }}

      - name: Resolve service URL
        id: url
        shell: bash
        run: |
          set -euo pipefail
          URL=$(gcloud run services describe "${{ vars.SERVICE }}" --region="${{ vars.REGION }}" --format='value(status.url)')
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: GET /_health
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS "${{ steps.url.outputs.url }}/_health"

      - name: GET /ops/submissions (tail)
        if: ${{ vars.OPS_DASHBOARD_ENABLED == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS -H "X-Admin-Key: ${{ secrets.ADMIN_DASHBOARD_KEY }}" "${{ steps.url.outputs.url }}/ops/submissions?limit=5" | jq .
