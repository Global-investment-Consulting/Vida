name: Alert on Smoke Failure

on:
  workflow_run:
    workflows: ["Staging Smoke Test", "Staging AP Webhook Smoke"]
    types: [completed]

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Open or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = "⚠️ Staging smoke failing";
            const body = `Run: ${context.payload.workflow_run.html_url}`;
            const query = `repo:${context.repo.owner}/${context.repo.repo} "${title}" in:title state:open`;
            const issues = await github.rest.search.issuesAndPullRequests({ q: query });

            if (issues.data.items.length > 0) {
              const issueNumber = issues.data.items[0].number;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            }
