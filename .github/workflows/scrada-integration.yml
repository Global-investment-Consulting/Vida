name: Scrada Integration

on:
  push:
    branches:
      - main
      - feat/scrada-e2e-clean
  workflow_dispatch:
    inputs:
      run_ref:
        description: "Git ref to run (default feat/scrada-e2e-clean)"
        required: false
        default: "feat/scrada-e2e-clean"

jobs:
  scrada:
    runs-on: ubuntu-latest
    env:
      VIDA_AP_ADAPTER: scrada
      SCRADA_API_KEY: ${{ secrets.SCRADA_API_KEY }}
      SCRADA_API_PASSWORD: ${{ secrets.SCRADA_API_PASSWORD }}
      SCRADA_COMPANY_ID: ${{ secrets.SCRADA_COMPANY_ID }}
      SCRADA_WEBHOOK_SECRET: ${{ secrets.SCRADA_WEBHOOK_SECRET }}
      SCRADA_API_BASE: ${{ vars.SCRADA_API_BASE }}
      SCRADA_LANGUAGE: ${{ vars.SCRADA_LANGUAGE }}
      SCRADA_TEST_RECEIVER_SCHEME: ${{ vars.SCRADA_TEST_RECEIVER_SCHEME }}
      SCRADA_TEST_RECEIVER_ID: ${{ vars.SCRADA_TEST_RECEIVER_ID }}
      SCRADA_SUPPLIER_SCHEME: ${{ vars.SCRADA_SUPPLIER_SCHEME }}
      SCRADA_SUPPLIER_ID: ${{ vars.SCRADA_SUPPLIER_ID }}
      SCRADA_SUPPLIER_VAT: ${{ vars.SCRADA_SUPPLIER_VAT }}
      SCRADA_RECEIVER_VAT: ${{ vars.SCRADA_RECEIVER_VAT }}
      SCRADA_SKIP_PARTICIPANT_PREFLIGHT: ${{ vars.SCRADA_SKIP_PARTICIPANT_PREFLIGHT }}
      SCRADA_PARTICIPANT_ID: ${{ format('{0}:{1}', vars.SCRADA_TEST_RECEIVER_SCHEME, vars.SCRADA_TEST_RECEIVER_ID) }}
      ARCHIVE_BUCKET: ${{ vars.ARCHIVE_BUCKET }}
      SCRADA_HEADER_SWEEP: "true"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_ref || github.ref }}

      - name: Use Node.js 20.19
        uses: actions/setup-node@v4
        with:
          node-version: "20.19.0"
          cache: "npm"

      - name: Mask Scrada secrets
        run: |
          echo "::add-mask::${SCRADA_API_KEY}"
          echo "::add-mask::${SCRADA_API_PASSWORD}"
          echo "::add-mask::${SCRADA_COMPANY_ID}"
          echo "::add-mask::${SCRADA_WEBHOOK_SECRET}"

      - name: env-presence (VAR=OK)
        shell: bash
        run: |
          set -euo pipefail
          required_vars=(
            VIDA_AP_ADAPTER
            SCRADA_API_KEY
            SCRADA_API_PASSWORD
            SCRADA_COMPANY_ID
            SCRADA_API_BASE
            SCRADA_LANGUAGE
            SCRADA_TEST_RECEIVER_SCHEME
            SCRADA_TEST_RECEIVER_ID
            SCRADA_SUPPLIER_SCHEME
            SCRADA_SUPPLIER_ID
            SCRADA_SUPPLIER_VAT
            SCRADA_RECEIVER_VAT
          )
          missing=0
          for var in "${required_vars[@]}"; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing required environment variable $var"
              missing=1
            else
              echo "${var}=OK"
            fi
          done
          if [ "${missing}" -ne 0 ]; then
            exit 1
          fi

      - run: rm -rf apps/api/node_modules apps/api/dist
        shell: bash

      - run: npm ci --workspaces || (npm ci && (cd apps/api && npm install --no-audit --no-fund))
        shell: bash

      - run: npm run build --workspaces || (npm run build && (cd apps/api && npm run build))
        shell: bash

      - name: Isolation check (no Billit vars)
        shell: bash
        run: |
          set -euo pipefail
          LEAKS=$(env | awk -F= '/^BILLIT_/ {print $1}')
          if [ -n "${LEAKS}" ]; then
            echo "::error::Unexpected Billit vars: ${LEAKS}"
            exit 1
          fi
          echo "Isolation=OK"

      - name: Show revision
        shell: bash
        run: |
          echo "Adapter=${VIDA_AP_ADAPTER}"
          echo "REF=${GITHUB_REF}"
          echo "SHA=${GITHUB_SHA}"
          git rev-parse HEAD
      - name: Run unit tests
        shell: bash
        run: |
          set -euo pipefail
          npm test -- --run apps/api/tests/scrada.*

      - name: Configure Scrada pass 0208
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/scrada
          echo "SCRADA_TEST_RECEIVER_SCHEME=0208" >> "$GITHUB_ENV"
          echo "SCRADA_TEST_RECEIVER_ID=${SCRADA_SUPPLIER_ID}" >> "$GITHUB_ENV"
          echo "SCRADA_PARTICIPANT_ID=0208:${SCRADA_SUPPLIER_ID}" >> "$GITHUB_ENV"
          echo "SCRADA_ARTIFACT_DIR=artifacts/scrada/0208" >> "$GITHUB_ENV"
          echo "ReceiverPass=0208" >> "$GITHUB_ENV"
          echo "Configured receiver pass 0208"

      - name: Wait for Scrada participant readiness (0208)
        if: ${{ env.SCRADA_SKIP_PARTICIPANT_PREFLIGHT != 'true' && env.SCRADA_SKIP_PARTICIPANT_PREFLIGHT != 'TRUE' }}
        id: scrada_participant_0208
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${SCRADA_ARTIFACT_DIR}"
          node apps/api/scripts/scrada-wait-participant.mjs --participant "${SCRADA_PARTICIPANT_ID}" > "${SCRADA_ARTIFACT_DIR}/participant.json"
          cat "${SCRADA_ARTIFACT_DIR}/participant.json"

      - name: Scrada smoke send (0208)
        id: scrada_send_0208
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${SCRADA_ARTIFACT_DIR}"
          send_log="${SCRADA_ARTIFACT_DIR}/scrada-send-output.log"
          send_json="${SCRADA_ARTIFACT_DIR}/scrada-send-output.json"
          rm -f "${send_log}" "${send_json}"
          set +e
          node apps/api/scripts/scrada-send.mjs --artifact-dir "${SCRADA_ARTIFACT_DIR}" --vat "${SCRADA_RECEIVER_VAT}" > "${send_log}" 2>&1
          send_exit=$?
          set -e
          cat "${send_log}"
          node - <<'NODE' "${send_log}" "${send_json}"
            const fs = require("fs");
            const [logPath, jsonPath] = process.argv.slice(2);
            if (!fs.existsSync(logPath)) {
              process.exit(0);
            }
            const text = fs.readFileSync(logPath, "utf8");
            for (let idx = text.length - 1; idx >= 0; idx -= 1) {
              if (text[idx] !== "{") {
                continue;
              }
              try {
                const data = JSON.parse(text.slice(idx));
                fs.writeFileSync(jsonPath, JSON.stringify(data, null, 2));
                break;
              } catch (error) {
                continue;
              }
            }
          NODE
          send_status="failure"
          document_id=""
          invoice_id=""
          external_reference=""
          send_channel=""
          vat_variant=""
          if [ -f "${send_json}" ] && jq -e '.success == true' "${send_json}" >/dev/null 2>&1; then
            send_status="success"
            document_id=$(jq -r '.documentId' "${send_json}")
            invoice_id=$(jq -r '.invoiceId' "${send_json}")
            external_reference=$(jq -r '.externalReference' "${send_json}")
            send_channel=$(jq -r '.channel' "${send_json}")
            vat_variant=$(jq -r '.vatVariant' "${send_json}")
            jq '.' "${send_json}"
          else
            if [ -f "${send_json}" ]; then
              jq '.' "${send_json}" || true
            fi
          fi
          echo "send_status=${send_status}" >> "$GITHUB_OUTPUT"
          echo "send_exit=${send_exit}" >> "$GITHUB_OUTPUT"
          echo "document_id=${document_id}" >> "$GITHUB_OUTPUT"
          echo "invoice_id=${invoice_id}" >> "$GITHUB_OUTPUT"
          echo "external_reference=${external_reference}" >> "$GITHUB_OUTPUT"
          echo "send_channel=${send_channel}" >> "$GITHUB_OUTPUT"
          echo "vat_variant=${vat_variant}" >> "$GITHUB_OUTPUT"
          if [ "${send_status}" != "success" ]; then
            echo "Scrada send (0208) did not complete successfully (exit=${send_exit})." >&2
          fi

      - name: Poll Scrada status and archive (0208)
        id: scrada_status_0208
        if: ${{ steps.scrada_send_0208.outputs.send_status == 'success' }}
        shell: bash
        run: |
          set -euo pipefail
          node apps/api/scripts/scrada-status.mjs "${{ steps.scrada_send_0208.outputs.document_id }}" --archive > "${SCRADA_ARTIFACT_DIR}/scrada-status.log"
          cat "${SCRADA_ARTIFACT_DIR}/scrada-status.log"
          jq -s '.' "${SCRADA_ARTIFACT_DIR}/scrada-status.log" > "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json"
          cat "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json"
          status=$(jq -r '.[0].status' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          classification=$(jq -r '.[0].classification' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          archive_driver=$(jq -r '.[1].driver // empty' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          archive_location=$(jq -r '.[1].location // empty' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          archive_key=$(jq -r '.[1].key // empty' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          echo "status=${status}" >> "$GITHUB_OUTPUT"
          echo "classification=${classification}" >> "$GITHUB_OUTPUT"
          echo "archive_driver=${archive_driver}" >> "$GITHUB_OUTPUT"
          echo "archive_location=${archive_location}" >> "$GITHUB_OUTPUT"
          echo "archive_key=${archive_key}" >> "$GITHUB_OUTPUT"

      - name: Configure Scrada pass 9925
        shell: bash
        run: |
          set -euo pipefail
          echo "SCRADA_TEST_RECEIVER_SCHEME=9925" >> "$GITHUB_ENV"
          echo "SCRADA_TEST_RECEIVER_ID=${SCRADA_RECEIVER_VAT}" >> "$GITHUB_ENV"
          echo "SCRADA_PARTICIPANT_ID=9925:${SCRADA_RECEIVER_VAT}" >> "$GITHUB_ENV"
          echo "SCRADA_ARTIFACT_DIR=artifacts/scrada/9925" >> "$GITHUB_ENV"
          echo "ReceiverPass=9925" >> "$GITHUB_ENV"
          echo "Configured receiver pass 9925"

      - name: Wait for Scrada participant readiness (9925)
        if: ${{ env.SCRADA_SKIP_PARTICIPANT_PREFLIGHT != 'true' && env.SCRADA_SKIP_PARTICIPANT_PREFLIGHT != 'TRUE' }}
        id: scrada_participant_9925
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${SCRADA_ARTIFACT_DIR}"
          node apps/api/scripts/scrada-wait-participant.mjs --participant "${SCRADA_PARTICIPANT_ID}" > "${SCRADA_ARTIFACT_DIR}/participant.json"
          cat "${SCRADA_ARTIFACT_DIR}/participant.json"

      - name: Scrada smoke send (9925)
        id: scrada_send_9925
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${SCRADA_ARTIFACT_DIR}"
          send_log="${SCRADA_ARTIFACT_DIR}/scrada-send-output.log"
          send_json="${SCRADA_ARTIFACT_DIR}/scrada-send-output.json"
          rm -f "${send_log}" "${send_json}"
          set +e
          node apps/api/scripts/scrada-send.mjs --artifact-dir "${SCRADA_ARTIFACT_DIR}" --vat "${SCRADA_RECEIVER_VAT}" > "${send_log}" 2>&1
          send_exit=$?
          set -e
          cat "${send_log}"
          node - <<'NODE' "${send_log}" "${send_json}"
            const fs = require("fs");
            const [logPath, jsonPath] = process.argv.slice(2);
            if (!fs.existsSync(logPath)) {
              process.exit(0);
            }
            const text = fs.readFileSync(logPath, "utf8");
            for (let idx = text.length - 1; idx >= 0; idx -= 1) {
              if (text[idx] !== "{") {
                continue;
              }
              try {
                const data = JSON.parse(text.slice(idx));
                fs.writeFileSync(jsonPath, JSON.stringify(data, null, 2));
                break;
              } catch (error) {
                continue;
              }
            }
          NODE
          send_status="failure"
          document_id=""
          invoice_id=""
          external_reference=""
          send_channel=""
          vat_variant=""
          if [ -f "${send_json}" ] && jq -e '.success == true' "${send_json}" >/dev/null 2>&1; then
            send_status="success"
            document_id=$(jq -r '.documentId' "${send_json}")
            invoice_id=$(jq -r '.invoiceId' "${send_json}")
            external_reference=$(jq -r '.externalReference' "${send_json}")
            send_channel=$(jq -r '.channel' "${send_json}")
            vat_variant=$(jq -r '.vatVariant' "${send_json}")
            jq '.' "${send_json}"
          else
            if [ -f "${send_json}" ]; then
              jq '.' "${send_json}" || true
            fi
          fi
          echo "send_status=${send_status}" >> "$GITHUB_OUTPUT"
          echo "send_exit=${send_exit}" >> "$GITHUB_OUTPUT"
          echo "document_id=${document_id}" >> "$GITHUB_OUTPUT"
          echo "invoice_id=${invoice_id}" >> "$GITHUB_OUTPUT"
          echo "external_reference=${external_reference}" >> "$GITHUB_OUTPUT"
          echo "send_channel=${send_channel}" >> "$GITHUB_OUTPUT"
          echo "vat_variant=${vat_variant}" >> "$GITHUB_OUTPUT"
          if [ "${send_status}" != "success" ]; then
            echo "Scrada send (9925) did not complete successfully (exit=${send_exit})." >&2
          fi

      - name: Poll Scrada status and archive (9925)
        id: scrada_status_9925
        if: ${{ steps.scrada_send_9925.outputs.send_status == 'success' }}
        shell: bash
        run: |
          set -euo pipefail
          node apps/api/scripts/scrada-status.mjs "${{ steps.scrada_send_9925.outputs.document_id }}" --archive > "${SCRADA_ARTIFACT_DIR}/scrada-status.log"
          cat "${SCRADA_ARTIFACT_DIR}/scrada-status.log"
          jq -s '.' "${SCRADA_ARTIFACT_DIR}/scrada-status.log" > "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json"
          cat "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json"
          status=$(jq -r '.[0].status' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          classification=$(jq -r '.[0].classification' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          archive_driver=$(jq -r '.[1].driver // empty' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          archive_location=$(jq -r '.[1].location // empty' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          archive_key=$(jq -r '.[1].key // empty' "${SCRADA_ARTIFACT_DIR}/scrada-status-output.json")
          echo "status=${status}" >> "$GITHUB_OUTPUT"
          echo "classification=${classification}" >> "$GITHUB_OUTPUT"
          echo "archive_driver=${archive_driver}" >> "$GITHUB_OUTPUT"
          echo "archive_location=${archive_location}" >> "$GITHUB_OUTPUT"
          echo "archive_key=${archive_key}" >> "$GITHUB_OUTPUT"

      - name: Upload Scrada artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scrada-flow-artifacts
          if-no-files-found: warn
          path: |
            artifacts/scrada/0208
            artifacts/scrada/9925
            ${{ steps.scrada_send_0208.outputs.document_id && format('.data/archive/peppol/{0}.xml', steps.scrada_send_0208.outputs.document_id) }}
            ${{ steps.scrada_send_9925.outputs.document_id && format('.data/archive/peppol/{0}.xml', steps.scrada_send_9925.outputs.document_id) }}
