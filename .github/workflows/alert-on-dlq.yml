name: Alert on DLQ Activity

on:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      METRICS_URL: https://vida-staging-mtsykhir3q-ew.a.run.app/metrics
    steps:
      - name: Check DLQ metrics
        id: inspect
        run: |
          set -Eeuo pipefail
          curl -sS "$METRICS_URL" | tee metrics.txt

          POSITIVE_LINES="$(grep -E '^(ap_send_fail_total|dlq_(items|retry)_total)[[:space:]]+([1-9][0-9]*)(\.|$)' metrics.txt || true)"

          if [[ -n "${POSITIVE_LINES}" ]]; then
            {
              echo "POSITIVE_LINES<<EOF"
              echo "${POSITIVE_LINES}"
              echo "EOF"
            } >> "$GITHUB_ENV"
            echo "::error::Detected AP send failures or DLQ items > 0"
            exit 1
          fi

          echo "DLQ/AP failure counters are zero — OK"

      - name: Open or update DLQ issue
        if: failure()
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const title = "⚠️ DLQ or AP send failures detected";
            const runUrl = process.env.RUN_URL;
            const fails = process.env.FAILS || "n/a";
            const dlqEntries = process.env.DLQ || "n/a";
            const snippet = require("fs").readFileSync("metrics.txt", "utf8").slice(0, 4000);
            const body = [
              `Run: ${runUrl}`,
              "",
              "ap_send_fail_total:",
              "```",
              fails,
              "```",
              "",
              "dlq entries:",
              "```",
              dlqEntries,
              "```",
              "",
              "Metrics snippet:",
              "```",
              snippet,
              "```"
            ].join("\n");
            const query = `repo:${context.repo.owner}/${context.repo.repo} "${title}" in:title state:open`;
            const issues = await github.rest.search.issuesAndPullRequests({ q: query });

            if (issues.data.items.length > 0) {
              const issueNumber = issues.data.items[0].number;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            }
