name: Manual Deploy Staging
on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why are you running this?
        required: false
        default: manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      SERVICE: ${{ vars.SERVICE }}
      IMAGE_TAG: staging

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          # Must be a JSON service account key with required roles
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build & push image (Cloud Build -> Artifact Registry)
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: ${{ vars.REGION }}
          SERVICE: ${{ vars.SERVICE }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          SRC_BUCKET: vida-staging-1760866919-cb-src
        run: |
          set -euo pipefail
          IMAGE_URI="europe-west1-docker.pkg.dev/${PROJECT_ID}/vida/vida:${IMAGE_TAG}"

          # 1) Create a reproducible source tarball from the repo
          cd "$GITHUB_WORKSPACE"
          git rev-parse HEAD
          tar -czf /tmp/src.tgz --exclude .git .

          # 2) Upload to our custom EU bucket (avoid the restricted _cloudbuild bucket)
          DEST="gs://${SRC_BUCKET}/builds/${GITHUB_RUN_ID}/src.tgz"
          echo "Uploading source tarball to: ${DEST}"
          gcloud storage cp /tmp/src.tgz "${DEST}"

          # 3) Submit the build from that exact GCS object, in the correct region
          echo "Submitting build in region ${REGION} from ${DEST}"
          BID="$(gcloud builds submit \
            --region="${REGION}" \
            --gcs-source="${DEST}" \
            --tag "${IMAGE_URI}" \
            --async --format='value(id)')"

          echo "Cloud Build ID: ${BID}"
          echo "Cloud Build logs: $(gcloud builds describe "${BID}" --region="${REGION}" --format='value(logUrl)')"

          for _ in $(seq 1 120); do
            S="$(gcloud builds describe "${BID}" --region="${REGION}" --format='value(status)')"
            echo "Cloud Build status: ${S}"
            case "$S" in SUCCESS) break ;; FAILURE|CANCELLED) exit 1 ;; esac
            sleep 5
          done

      - name: Deploy to Cloud Run
        run: |
          set -euo pipefail
          IMAGE_URI="europe-west1-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/vida/vida:${{ env.IMAGE_TAG }}"
          gcloud run deploy "${{ vars.SERVICE }}" \
            --project "${{ vars.GCP_PROJECT_ID }}" \
            --region "${{ vars.REGION }}" \
            --image "${IMAGE_URI}" \
            --platform managed \
            --quiet

      - name: Verify deployment
        run: |
          set -euo pipefail
          URL="$(gcloud run services describe "${{ vars.SERVICE }}" --project "${{ vars.GCP_PROJECT_ID }}" --region "${{ vars.REGION }}" --format='value(status.url)')"
          echo "Service URL: $URL"
          for p in /_health /health /healthz/; do
            printf "%-9s -> %s\n" "$p" "$(curl -fs -o /dev/null -w '%{http_code}' "$URL$p" || true)"
          done