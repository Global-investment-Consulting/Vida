name: Manual Deploy Staging
on:
  workflow_dispatch:
    inputs:
      reason:
        description: Why are you running this?
        required: false
        default: manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      SERVICE: ${{ vars.SERVICE }}
      IMAGE_TAG: staging

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build & push image (Cloud Build -> Artifact Registry)
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: ${{ vars.REGION }}
          SERVICE: ${{ vars.SERVICE }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
          CLOUD_BUILD_BUCKET: ${{ vars.CLOUD_BUILD_BUCKET }}
        run: |
          set -euo pipefail
          IMAGE_URI="europe-west1-docker.pkg.dev/${PROJECT_ID}/vida/vida:${IMAGE_TAG}"

          # Sanitize custom bucket into a pure bucket dir, or skip if unset
          GCS_FLAG=""
          if [ -n "${CLOUD_BUILD_BUCKET:-}" ]; then
            BUCKET="${CLOUD_BUILD_BUCKET#gs://}"
            BUCKET="${BUCKET%%/*}"
            if [ -n "$BUCKET" ]; then
              # trailing slash forces directory semantics on the bucket
              GCS_FLAG="--gcs-source-staging-dir=gs://${BUCKET}/"
            fi
          fi

          REG_FLAG="--region=${REGION}"

          echo "Building to: ${IMAGE_URI}"
          echo "Using GCS flag: ${GCS_FLAG:-<none>}"
          echo "Using Cloud Build region: ${REGION}"

          BID="$(gcloud builds submit ${REG_FLAG} ${GCS_FLAG} --tag "${IMAGE_URI}" --async --format='value(id)')"
          echo "Cloud Build ID: ${BID}"
          echo "Cloud Build logs: $(gcloud builds describe "${BID}" --region="${REGION}" --format='value(logUrl)')"

          for _ in $(seq 1 120); do
            S="$(gcloud builds describe "${BID}" --region="${REGION}" --format='value(status)')"
            echo "Cloud Build status: ${S}"
            case "$S" in SUCCESS) break ;; FAILURE|CANCELLED) exit 1 ;; esac
            sleep 5
          done

      - name: Deploy to Cloud Run
        run: |
          set -euo pipefail
          IMAGE_URI="europe-west1-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/vida/vida:${{ env.IMAGE_TAG }}"
          gcloud run deploy "${{ vars.SERVICE }}" \
            --project "${{ vars.GCP_PROJECT_ID }}" \
            --region "${{ vars.REGION }}" \
            --image "${IMAGE_URI}" \
            --platform managed \
            --quiet

      - name: Verify deployment
        run: |
          set -euo pipefail
          URL="$(gcloud run services describe "${{ vars.SERVICE }}" --project "${{ vars.GCP_PROJECT_ID }}" --region "${{ vars.REGION }}" --format='value(status.url)')"
          echo "Service URL: $URL"
          for p in /_health /health /healthz/; do
            printf "%-9s -> %s\n" "$p" "$(curl -fs -o /dev/null -w '%{http_code}' "$URL$p" || true)"
          done