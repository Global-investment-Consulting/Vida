name: "Smoke AP Billit (Sandbox â€” LIVE call)"

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type YES_I_UNDERSTAND to allow the live sandbox call"
        required: false
        default: "YES_I_UNDERSTAND"

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.gate_check.outputs.enabled }}
    steps:
      - id: gate_check
        shell: bash
        env:
          CONFIRM: ${{ inputs.confirm }}
          BILLIT_SANDBOX: ${{ vars.BILLIT_SANDBOX }}
          SB_URL: ${{ secrets.AP_BASE_URL }}
          SB_ID: ${{ secrets.AP_CLIENT_ID }}
          SB_SECRET: ${{ secrets.AP_CLIENT_SECRET }}
          SB_KEY: ${{ secrets.AP_API_KEY }}
        run: |
          set -Eeuo pipefail
          ok=true
          if [ "${CONFIRM:-}" != "YES_I_UNDERSTAND" ]; then
            echo "confirm input not acknowledged"
            ok=false
          fi
          if [ "${BILLIT_SANDBOX:-}" != "true" ]; then
            echo "BILLIT_SANDBOX var must be true"
            ok=false
          fi
          for var in SB_URL SB_ID SB_SECRET SB_KEY; do
            if [ -z "${!var:-}" ]; then
              echo "$var: missing"
              ok=false
            else
              echo "$var: present"
            fi
          done
          echo "enabled=${ok}" >> "$GITHUB_OUTPUT"

  live:
    needs: gate
    if: ${{ needs.gate.outputs.enabled == 'true' }}
    runs-on: ubuntu-latest
    env:
      # Selectors and document settings
      AP_ENV:               live
      BILLIT_RX_SCHEME:     ${{ vars.BILLIT_RX_SCHEME }}
      BILLIT_RX_VALUE:      ${{ vars.BILLIT_RX_VALUE }}
      BILLIT_DOC_TYPE:      ${{ vars.BILLIT_DOC_TYPE }}
      BILLIT_VAT_RATE:      ${{ vars.BILLIT_VAT_RATE }}
      BILLIT_CURRENCY:      ${{ vars.BILLIT_CURRENCY }}
      BILLIT_SELLER_VAT:    ${{ vars.BILLIT_SELLER_VAT }}
      # Adapter secrets (prefer API key, fallback OAuth)
      AP_BASE_URL:          ${{ secrets.AP_BASE_URL }}
      AP_API_KEY:           ${{ secrets.AP_API_KEY }}
      AP_CLIENT_ID:         ${{ secrets.AP_CLIENT_ID }}
      AP_CLIENT_SECRET:     ${{ secrets.AP_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Build minimal invoice
        run: |
          mkdir -p reports
          node -e "require('fs').writeFileSync('reports/invoice.sb.json', JSON.stringify({lines:[{desc:'sb-live smoke',qty:1,price:1.00}],buyer:{name:'Test Buyer'},seller:{name:'ViDA'}},null,2))"
      - id: live_send
        name: Send to Billit (sandbox)
        run: node scripts/billit_send_smoke.mjs
        continue-on-error: true
      - name: Upload artifact (always, even on failure)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: billit-sandbox-live.json
          path: reports/billit-sandbox-live.json
          if-no-files-found: warn
      - name: Fail if send failed
        if: ${{ steps.live_send.outcome == 'failure' }}
        run: |
          echo "Billit live send failed; see uploaded report for details."
          exit 1
