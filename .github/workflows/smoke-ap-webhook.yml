name: Staging AP Webhook Smoke
on:
  workflow_dispatch:
    inputs:
      providerId:
        description: "Provider ID to simulate"
        required: false
        default: "mock-integration-test"
      status:
        description: "Status to set (queued|sent|delivered|error)"
        required: false
        default: "delivered"
  push:
    paths:
      - ".github/workflows/smoke-ap-webhook.yml"
jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      STAGING_URL: https://vida-staging-mtsykhir3q-ew.a.run.app
      AP_WEBHOOK_SECRET: ${{ secrets.AP_WEBHOOK_SECRET }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Build signed payload
        id: build
        run: |
          TS=$(date -u +%s)
          PROVIDER_ID="${{ github.event.inputs.providerId || 'mock-integration-test' }}"
          STATUS="${{ github.event.inputs.status || 'delivered' }}"
          cat > payload.json <<JSON
          { "event":"status","providerId":"$PROVIDER_ID","status":"$STATUS","eventId":"smoke-$TS","timestamp":$TS }
          JSON
          SIG=$(node -e "const c=require('crypto');const fs=require('fs');const s=process.env.AP_WEBHOOK_SECRET;const b=fs.readFileSync('payload.json');process.stdout.write(c.createHmac('sha256',s).update(b).digest('hex'))")
          echo "TS=$TS" >> $GITHUB_ENV
          echo "SIG=$SIG" >> $GITHUB_ENV
      - name: POST signed webhook
        run: |
          set -e
          CODE=$(curl -sS -o resp.txt -w "%{http_code}" -X POST "$STAGING_URL/ap/status-webhook" \
            -H "Content-Type: application/json" \
            -H "X-AP-Signature: $SIG" \
            -H "X-Event-ID: smoke-$TS" \
            -H "X-Event-Timestamp: $TS" \
            --data-binary @payload.json)
          echo "HTTP $CODE"
          test "$CODE" = "200"
      - name: Metrics head
        run: |
          curl -sS "$STAGING_URL/metrics" | grep -E "ap_webhook_ok_total|ap_webhook_fail_total|ap_webhook_latency_ms" | sed -n '1,20p'
