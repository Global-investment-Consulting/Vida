name: Staging AP Webhook Smoke
on:
  workflow_dispatch:
    inputs:
      providerId:
        description: "Provider ID to simulate"
        required: false
        default: "mock-integration-test"
      status:
        description: "Status to set (queued|sent|delivered|error)"
        required: false
        default: "delivered"
jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      STAGING_URL: https://vida-staging-731655778429.europe-west1.run.app
      AP_WEBHOOK_SECRET: ${{ secrets.AP_WEBHOOK_SECRET }}
      STAGING_SMOKE_API_KEY: ${{ secrets.STAGING_SMOKE_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Check secrets
        run: |
          missing=false
          if [ -z "$AP_WEBHOOK_SECRET" ]; then
            echo "AP_WEBHOOK_SECRET is missing"
            missing=true
          fi
          if [ -z "$STAGING_SMOKE_API_KEY" ]; then
            echo "STAGING_SMOKE_API_KEY is missing"
            missing=true
          fi
          if [ "$missing" = true ]; then
            exit 2
          fi
      - name: Tools
        run: |
          which jq || (sudo apt-get update -y && sudo apt-get install -y jq)
          which curl || (echo "curl missing" && exit 3)
      - name: Build signed payload
        id: build
        run: |
          TS=$(date -u +%s)
          PROVIDER_ID="${{ github.event.inputs.providerId || 'mock-integration-test' }}"
          STATUS="${{ github.event.inputs.status || 'delivered' }}"
          cat > payload.json <<JSON
          { "tenant":"smoke-suite","invoiceId":"smoke-$TS","providerId":"$PROVIDER_ID","status":"$STATUS","attempts":1 }
          JSON
          SIG=$(node -e "const c=require('crypto');const fs=require('fs');const s=process.env.AP_WEBHOOK_SECRET;const b=fs.readFileSync('payload.json');process.stdout.write(c.createHmac('sha256',s).update(b).digest('hex'))")
          echo "TS=$TS" >> $GITHUB_ENV
          echo "SIG=$SIG" >> $GITHUB_ENV
      - name: POST signed webhook
        run: |
          set -e
          CODE=$(curl -sS -D headers.txt -o resp.txt -w "%{http_code}" -X POST "$STAGING_URL/ap/status-webhook" \
            -H "Content-Type: application/json" \
            -H "X-AP-Signature: $SIG" \
            -H "X-Event-ID: smoke-$TS" \
            -H "X-Event-Timestamp: $TS" \
            -H "x-api-key: $STAGING_SMOKE_API_KEY" \
            --data-binary @payload.json || true)
          echo "HTTP $CODE"
          echo "===RESP HEADERS==="
          sed -n '1,50p' headers.txt || true
          echo "===RESP BODY==="
          sed -n '1,120p' resp.txt || true
          test "$CODE" = "200"
      - name: Metrics head
        if: always()
        run: |
          curl -sS "$STAGING_URL/metrics" | tee metrics.txt
          (grep -E "ap_webhook_ok_total|ap_webhook_fail_total|ap_webhook_latency_ms" metrics.txt || true) | sed -n '1,20p'
