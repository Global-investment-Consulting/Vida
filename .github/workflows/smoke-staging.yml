name: Staging Smoke Test

on:
  workflow_dispatch:

jobs:
  staging-smoke-test:
    name: Staging Smoke Test
    runs-on: ubuntu-latest
    env:
      STAGING_URL: https://vida-staging-mtsykhir3q-ew.a.run.app
      STAGING_SMOKE_API_KEY: ${{ secrets.STAGING_SMOKE_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Prepare smoke payload
        run: |
          set -Eeuo pipefail
          TS="$(date +%s)"
          ISSUE_DATE="$(date -u +%Y-%m-%d)"
          cat <<JSON > order.json
          {
            "source": "order",
            "payload": {
              "orderNumber": "SMK-${TS}",
              "currency": "EUR",
              "issueDate": "${ISSUE_DATE}",
              "buyer": {
                "name": "Smoke Test BV",
                "vatId": "BE0123456789",
                "address": {
                  "streetName": "Smoke Street 1",
                  "cityName": "Brussels",
                  "postalZone": "1000",
                  "countryCode": "BE"
                }
              },
              "supplier": {
                "name": "Vida Demo BV",
                "vatId": "BE0987654321",
                "address": {
                  "streetName": "Avenue Deploy 42",
                  "cityName": "Brussels",
                  "postalZone": "1000",
                  "countryCode": "BE"
                },
                "contact": {
                  "electronicMail": "smoke@vida.example"
                }
              },
              "defaultVatRate": 21,
              "lines": [
                {
                  "description": "Smoke Test Line",
                  "quantity": 1,
                  "unitPriceMinor": 10000,
                  "vatRate": 21
                },
                {
                  "description": "Shipping",
                  "quantity": 1,
                  "unitPriceMinor": 1000,
                  "vatRate": 21
                }
              ]
            }
          }
          JSON
          cat order.json
          : > curl_status.log

      - name: Health
        run: |
          set -Eeuo pipefail
          check() {
            local path="$1"
            local header_file
            header_file="$(mktemp)"
            local body_file
            body_file="$(mktemp)"
            if curl -sS -D "$header_file" -o "$body_file" "$STAGING_URL$path"; then
              local status
              status="$(head -n1 "$header_file" | awk '{print $2}')"
              head -n1 "$header_file"
              printf '%s exit=%s status=%s\n' "$path" "0" "${status:-n/a}" >> curl_status.log
              if [[ "${status}" != "200" ]]; then
                echo "Unexpected status $status for $path" >&2
                exit 1
              fi
            else
              local ec=$?
              head -n1 "$header_file" || true
              local status
              status="$(head -n1 "$header_file" | awk '{print $2}')"
              printf '%s exit=%s status=%s\n' "$path" "$ec" "${status:-n/a}" >> curl_status.log
              exit "$ec"
            fi
          }

          check "/_health"
          check "/healthz/"

      - name: Create invoice
        run: |
          set -Eeuo pipefail
          headers="$(mktemp)"
          ts="$(date +%s)"
          curl -sS -D "$headers" -o response.json \
            -X POST "$STAGING_URL/webhook/order-created" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $STAGING_SMOKE_API_KEY" \
            -H "Idempotency-Key: smoke-$ts" \
            --data-binary @order.json
          ec=$?
          status="$(head -n1 "$headers" | awk '{print $2}')"
          printf '%s exit=%s status=%s\n' '/webhook/order-created' "$ec" "${status:-n/a}" >> curl_status.log
          cat response.json
          if [[ "$ec" -ne 0 || "${status}" != "200" ]]; then
            echo "Invoice creation failed (exit=$ec, status=${status:-n/a})" >&2
            exit 1
          fi
          if [[ "$(jq -r '.invoiceId // empty' response.json)" == "" || "$(jq -r '.invoiceId' response.json)" == "null" ]]; then
            echo "Missing invoiceId in response" >&2
            exit 1
          fi

      - name: Check invoice status
        run: |
          set -Eeuo pipefail
          ID="$(jq -r '.invoiceId' response.json)"
          if [[ -z "$ID" || "$ID" == "null" ]]; then
            echo "Missing invoiceId for status polling" >&2
            exit 1
          fi

          request_status() {
            local label="$1"
            local headers
            headers="$(mktemp)"
            local body
            body="$(mktemp)"
            if curl -sS -D "$headers" -o "$body" \
              "$STAGING_URL/invoice/$ID/status" \
              -H "x-api-key: $STAGING_SMOKE_API_KEY"; then
              local http
              http="$(head -n1 "$headers" | awk '{print $2}')"
              printf '/invoice/%s/status (%s) exit=0 status=%s\n' "$ID" "$label" "${http:-n/a}" >> curl_status.log
            else
              local ec=$?
              local http
              http="$(head -n1 "$headers" | awk '{print $2}')"
              printf '/invoice/%s/status (%s) exit=%s status=%s\n' "$ID" "$label" "$ec" "${http:-n/a}" >> curl_status.log
              exit "$ec"
            fi
            cp "$body" status.json
            jq -r '.status // empty' status.json
          }

          initial_status="$(request_status initial)"
          if [[ -z "$initial_status" ]]; then
            echo "Missing status in response" >&2
            exit 1
          fi
          if [[ "$initial_status" != "queued" && "$initial_status" != "delivered" ]]; then
            echo "Unexpected initial status: $initial_status" >&2
            exit 1
          fi

          final_status="$initial_status"
          if [[ "$initial_status" == "queued" ]]; then
            for attempt in {1..30}; do
              sleep 1
              current_status="$(request_status "poll-$attempt")"
              if [[ -z "$current_status" ]]; then
                echo "Status response missing during poll" >&2
                exit 1
              fi
              final_status="$current_status"
              if [[ "$current_status" == "delivered" ]]; then
                break
              fi
            done
          fi

          echo "$initial_status" > status_initial.txt
          echo "$final_status" > status_final.txt
          jq -r '.providerId // empty' status.json > provider_id.txt
          echo "Initial status: $initial_status"
          echo "Final status: $final_status"
          jq '.' status.json
          if [[ "$final_status" != "delivered" ]]; then
            echo "Invoice status did not reach 'delivered' within timeout" >&2
            exit 1
          fi

      - name: Fetch UBL
        run: |
          set -Eeuo pipefail
          ID="$(jq -r '.invoiceId' response.json)"
          echo "Fetching UBL for invoice ${ID}"
          headers="$(mktemp)"
          tmp_body="$(mktemp)"
          curl -sS -D "$headers" "$STAGING_URL/invoice/$ID" \
            -H "x-api-key: $STAGING_SMOKE_API_KEY" \
            -o "$tmp_body"
          ec=$?
          status="$(head -n1 "$headers" | awk '{print $2}')"
          printf '%s exit=%s status=%s\n' "/invoice/${ID}" "$ec" "${status:-n/a}" >> curl_status.log
          if [[ "$ec" -ne 0 || "${status}" != "200" ]]; then
            echo "Failed to fetch invoice XML (exit=$ec, status=${status:-n/a})" >&2
            exit 1
          fi
          head -n 40 "$tmp_body" | tee ubl_head.txt

      - name: Curl summary
        if: always()
        run: |
          echo "=== curl status log ==="
          cat curl_status.log

      - name: Curl diagnostics on failure
        if: failure()
        run: |
          echo "=== curl status log ==="
          cat curl_status.log || echo "curl_status.log missing"
          echo "=== response.json ==="
          cat response.json 2>/dev/null || echo "response.json missing"
