name: Deploy staging

on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION:     ${{ vars.REGION }}
      SERVICE:    ${{ vars.SERVICE }}
      IMAGE_TAG:  staging
    steps:
      - uses: actions/checkout@v4

      - name: Sanity check secret parses (no output)
        run: node -e "JSON.parse(process.env.GCP_SA_KEY); process.stdout.write('ok\n')"
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Enable required services (non-fatal)
        run: |
          set -euo pipefail
          for s in run.googleapis.com artifactregistry.googleapis.com cloudbuild.googleapis.com; do
            gcloud services enable "$s" && echo "enabled $s" || echo "skip enable $s"
          done

      - name: Build & push image (Cloud Build -> Artifact Registry)
        env:
          IMAGE_URI: europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/vida/vida:${{ env.IMAGE_TAG }}
        run: |
          set -euo pipefail
          BID=$(gcloud builds submit --tag "$IMAGE_URI" --async --format='value(id)')
          echo "Cloud Build ID: $BID"
          LOG_URL=$(gcloud builds describe "$BID" --format='value(logUrl)')
          echo "Cloud Build logs: $LOG_URL"
          for i in {1..90}; do
            S=$(gcloud builds describe "$BID" --format='value(status)')
            echo "Cloud Build status: $S"
            case "$S" in SUCCESS) break;; FAILURE|CANCELLED) exit 1;; esac
            sleep 5
          done

      - name: Deploy to Cloud Run
        env:
          IMAGE_URI:  europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/vida/vida:${{ env.IMAGE_TAG }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          gcloud run deploy "${SERVICE}" --image "${IMAGE_URI}" --region "${REGION}" \
            --allow-unauthenticated \
            --set-env-vars "JWT_SECRET=${JWT_SECRET},PEPPOL_MODE=sandbox" \
            --timeout 600s

      - name: Verify deployment
        run: |
          set -Eeuo pipefail
          URL=$(gcloud run services describe "${SERVICE}" --region "${REGION}" --format='value(status.url)')
          echo "Service URL: $URL" | tee -a "$GITHUB_STEP_SUMMARY"
          ok=1
          for p in /_health /_health/ /health /healthz/ /healthz; do
            if curl -fsS "$URL$p" >/dev/null; then
              echo "Health OK at $p" | tee -a "$GITHUB_STEP_SUMMARY"
              ok=0
              break
            else
              echo "Probe failed at $p (non-fatal, trying next)" | tee -a "$GITHUB_STEP_SUMMARY"
            fi
          done
          exit $ok
