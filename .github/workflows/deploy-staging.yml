name: Deploy staging
on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["CI"]
    types: [completed]
permissions: {contents: read}
jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      SERVICE: ${{ vars.SERVICE }}
      IMAGE_TAG: staging
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with: {credentials_json: ${{ secrets.GCP_SA_KEY }}}
      - uses: google-github-actions/setup-gcloud@v2
        with: {project_id: ${{ env.PROJECT_ID }}}
      - run: gcloud services enable run.googleapis.com artifactregistry.googleapis.com cloudbuild.googleapis.com
      - name: Build & push image
        run: |
          IMAGE_URI=europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/vida/vida:${{ env.IMAGE_TAG }}
          gcloud builds submit --tag "$IMAGE_URI"
      - name: Deploy to Cloud Run
        env: {JWT_SECRET: ${{ secrets.JWT_SECRET }}}
        run: |
          IMAGE_URI=europe-west1-docker.pkg.dev/${{ env.PROJECT_ID }}/vida/vida:${{ env.IMAGE_TAG }}
          gcloud run deploy $SERVICE --image "$IMAGE_URI" --region "$REGION" \
            --allow-unauthenticated --set-env-vars "JWT_SECRET=$JWT_SECRET,PEPPOL_MODE=sandbox" --timeout 600s
      - name: Verify
        run: |
          URL=$(gcloud run services describe $SERVICE --region $REGION --format='value(status.url)')
          for p in /health /_health /healthz /healthz/; do curl -fsSL "$URL$p" && echo "$p OK" && exit 0; done
          echo "Health check failed"; exit 1
