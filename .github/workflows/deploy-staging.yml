name: Deploy staging
on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["CI"]
    types: [completed]
permissions:
  contents: read
  actions: read
  id-token: write

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: grab
        uses: actions/github-script@v7
        with:
          script: |
            const {owner,repo}=context.repo
            async function runId(){
              if(context.eventName==="workflow_run"){
                const r=context.payload.workflow_run
                if(!r||r.head_branch!=="main"||r.conclusion!=="success")return null
                return r.id
              }
              const rs=await github.rest.actions.listWorkflowRuns({owner,repo,workflow_id:"ci.yml",branch:"main",per_page:5})
              const h=rs.data.workflow_runs.find(r=>r.status==="completed"&&r.conclusion==="success")
              return h?.id
            }
            const id=await runId(); if(!id){core.setFailed("No successful CI run");return}
            const jobs=await github.paginate(github.rest.actions.listJobsForWorkflowRun,{owner,repo,run_id:id})
            const j=jobs.find(x=>(x.name||"").includes("Build Docker image"))
            if(!j){core.setFailed("Docker job missing");return}
            const {data}=await github.rest.actions.downloadJobLogsForWorkflowRun({owner,repo,job_id:j.id})
            let b=Buffer.from(data);try{b=require("zlib").gunzipSync(b)}catch{}
            const m=b.toString("utf8").match(/containerimage\.digest":\s*"([^"]+)"/)
            if(!m){core.setFailed("Digest not found");return}
            core.setOutput("digest",m[1])
      - uses: superfly/flyctl-actions/setup-flyctl@v1
      - id: deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          IMAGE: ${{ vars.DOCKERHUB_IMAGE || format('{0}/vida', secrets.DOCKERHUB_USERNAME) }}
          DIGEST: ${{ steps.grab.outputs.digest }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          set -e
          export FLY_ACCESS_TOKEN="$FLY_API_TOKEN"
          flyctl auth whoami >/dev/null 2>&1 || { echo "Bad Fly token"; exit 1; }
          flyctl apps show vida-staging >/dev/null 2>&1 || flyctl apps create vida-staging
          printf "JWT_SECRET=%s\nPEPPOL_MODE=sandbox\n" "$JWT_SECRET" | flyctl secrets set --app vida-staging --stage
          flyctl deploy --app vida-staging --image "docker.io/${IMAGE}@${DIGEST}" --yes
          host=$(flyctl status --app vida-staging --json | jq -r '.hostname')
          echo "Staging URL: https://${host}" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "Image digest: ${DIGEST}" | tee -a "$GITHUB_STEP_SUMMARY"
          curl -fsSL "https://${host}/healthz" >/dev/null
