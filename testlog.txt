
> vida-mvp-nodb@0.5.0 test:ci
> vitest run --reporter=dot --silent


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90m/home/samgo/Vida[39m

[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[2m[90m-[39m[22m[33m[39m[32mÂ·[39m[33m[39m[2m[90m-[39m[22m[33m[39m[2m[90m-[39m[22m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[31mx[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[31mx[39m[33m[39m[31mx[39m[33m[39m[31mx[39m[33m[39m[31mx[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m[33m[39m[32mÂ·[39m

[31mâ¯â¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 5 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m tests/api/invoices.api.test.ts[2m > [22mv0 invoices API[2m > [22menforces per-key rate limits
[31m[1mError[22m: expected 202 "Accepted", got 429 "Too Many Requests"[39m
[36m [2mâ¯[22m tests/api/invoices.api.test.ts:[2m183:10[22m[39m
    [90m181| [39m        [33m.[39m[35mset[39m([32m"Idempotency-Key"[39m[33m,[39m [32m`rk-[39m[36m${[39mi[36m}[39m[32m`[39m)
    [90m182| [39m        [33m.[39m[34msend[39m(payload)
    [90m183| [39m        [33m.[39m[34mexpect[39m(i [33m===[39m [34m5[39m [33m?[39m [34m429[39m [33m:[39m [34m202[39m)[33m;[39m
    [90m   | [39m         [31m^[39m
    [90m184| [39m    }
    [90m185| [39m  })[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/5]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/api/invoices.api.test.ts[2m > [22mv0 invoices API[2m > [22mexposes submissions feed and allows resends
[31m[1mError[22m: expected 202 "Accepted", got 429 "Too Many Requests"[39m
[36m [2mâ¯[22m tests/api/invoices.api.test.ts:[2m194:8[22m[39m
    [90m192| [39m      [33m.[39m[35mset[39m([32m"Idempotency-Key"[39m[33m,[39m [32m"dashboard-list"[39m)
    [90m193| [39m      [33m.[39m[34msend[39m(payload)
    [90m194| [39m      [33m.[39m[34mexpect[39m([34m202[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m195| [39m
    [90m196| [39m    [35mconst[39m listResponse [33m=[39m [35mawait[39m [34mrequest[39m(app)
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/5]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/api/invoices.api.test.ts[2m > [22mv0 invoices API[2m > [22mshort-circuits duplicate submissions with the same idempotency key
[31m[1mError[22m: expected 202 "Accepted", got 429 "Too Many Requests"[39m
[36m [2mâ¯[22m tests/api/invoices.api.test.ts:[2m222:8[22m[39m
    [90m220| [39m      [33m.[39m[35mset[39m([32m"Idempotency-Key"[39m[33m,[39m [32m"dup-key-1"[39m)
    [90m221| [39m      [33m.[39m[34msend[39m(payload)
    [90m222| [39m      [33m.[39m[34mexpect[39m([34m202[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m223| [39m
    [90m224| [39m    [35mconst[39m secondResponse [33m=[39m [35mawait[39m [34mrequest[39m(app)
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/5]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/api/invoices.api.test.ts[2m > [22mv0 invoices API[2m > [22mcreates invoice, persists artifacts, and refreshes status
[31m[1mError[22m: expected 202 "Accepted", got 429 "Too Many Requests"[39m
[36m [2mâ¯[22m tests/api/invoices.api.test.ts:[2m247:8[22m[39m
    [90m245| [39m      [33m.[39m[35mset[39m([32m"Idempotency-Key"[39m[33m,[39m [32m"idem-primary"[39m)
    [90m246| [39m      [33m.[39m[34msend[39m(payload)
    [90m247| [39m      [33m.[39m[34mexpect[39m([34m202[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m248| [39m
    [90m249| [39m    [34mexpect[39m(sendMock)[33m.[39m[34mtoHaveBeenCalledOnce[39m()[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/5]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/api/status-routes.test.ts[2m > [22mAP status routes[2m > [22mreturns stored invoice delivery status
[31m[1mAssertionError[22m: expected { status: 'delivered', â€¦(1) } to deeply equal { status: 'queued', â€¦(1) }[39m

[32m- Expected[39m
[31m+ Received[39m

[2m  {[22m
[2m    "providerId": "mock-INV-001",[22m
[32m-   "status": "queued",[39m
[31m+   "status": "delivered",[39m
[2m  }[22m

[36m [2mâ¯[22m tests/api/status-routes.test.ts:[2m81:27[22m[39m
    [90m 79| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m 80| [39m
    [90m 81| [39m    [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoEqual[39m({
    [90m   | [39m                          [31m^[39m
    [90m 82| [39m      status[33m:[39m [32m"queued"[39m[33m,[39m
    [90m 83| [39m      providerId[33m:[39m [32m"mock-INV-001"[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/5]â¯[22m[39m


[2m Test Files [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m29 passed[39m[22m[2m | [22m[33m3 skipped[39m[90m (34)[39m
[2m      Tests [22m [1m[31m5 failed[39m[22m[2m | [22m[1m[32m84 passed[39m[22m[2m | [22m[33m3 skipped[39m[90m (92)[39m
[2m   Start at [22m 22:46:30
[2m   Duration [22m 21.12s[2m (transform 6.44s, setup 1.15s, collect 134.67s, tests 66.39s, environment 750ms, prepare 36.49s)[22m

